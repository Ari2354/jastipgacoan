<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pemesanan Ojek dengan Pelacakan Realtime - Jastip Jember</title>
  <meta name="description" content="Panel pemesanan ojek dengan login, izin lokasi, dan pemilihan alamat via Google Maps" />
  <link href="https://cdn.tailwindcss.com" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&amp;display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Poppins', sans-serif;
      background-color: #f9fafb;
      color: #111827;
    }
    body.dark {
      background-color: #111827;
      color: #f3f4f6;
    }
    #app {
      max-width: 900px;
      margin: 2rem auto;
      padding: 1rem;
      background: white;
      border-radius: 1rem;
      box-shadow: 0 24px 48px rgba(0,0,0,0.1);
      min-height: 700px;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    body.dark #app {
      background: #1f2937;
      box-shadow: 0 24px 48px rgba(16,185,129,0.4);
      color: #d1d5db;
    }
    h1 {
      font-weight: 700;
      font-size: 2.25rem;
      text-align: center;
      margin-bottom: 1rem;
    }
    label {
      font-weight: 600;
      margin-bottom: 0.25rem;
      display: block;
      color: #374151;
    }
    body.dark label {
      color: #9ca3af;
    }
    input[type=text], input[type=password] {
      width: 100%;
      padding: 0.6rem 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 0.6rem;
      font-size: 1rem;
      transition: border-color 0.3s;
      color: inherit;
      background: white;
    }
    body.dark input[type=text], body.dark input[type=password] {
      background: #374151;
      border-color: #4b5563;
    }
    input[type=text]:focus, input[type=password]:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 8px #3b82f6aa;
    }
    button {
      background-color: #3b82f6;
      color: white;
      font-weight: 700;
      padding: 0.75rem 0;
      border-radius: 9999px;
      cursor: pointer;
      font-size: 1.125rem;
      transition: background-color 0.3s ease;
      border: none;
    }
    button:hover, button:focus-visible {
      background-color: #2563eb;
      outline-offset: 4px;
      outline: 4px solid #2563ebaa;
    }
    button:disabled {
      background-color: #9ca3af;
      cursor: not-allowed;
      outline: none;
    }
    #login-panel, #order-panel {
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    #login-panel[hidden], #order-panel[hidden] {
      display: none;
    }
    #error-msg {
      color: #ef4444;
      font-weight: 600;
      min-height: 1.25rem;
      font-size: 0.9rem;
    }
    #map {
      width: 100%;
      height: 300px;
      border-radius: 1rem;
      margin-top: 0.8rem;
      box-shadow: 0 10px 24px rgb(59 130 246 / 0.15);
      user-select: none;
    }
    .info {
      padding: 0.75rem 1rem;
      font-size: 1rem;
      font-weight: 600;
      background-color: #e0f2fe;
      border-radius: 0.6rem;
      color: #0c4a6e;
      user-select: none;
      box-shadow: 0 4px 12px rgb(14 165 233 / 0.4);
    }
    body.dark .info {
      background-color: #0c4a6e;
      color: #bae6fd;
      box-shadow: 0 4px 14px rgb(14 165 233 / 0.8);
    }
    .permission-request {
      margin-top: 0.5rem;
      font-weight: 500;
      font-size: 0.9rem;
      color: #6b7280;
    }
    body.dark .permission-request {
      color: #9ca3af;
    }
    .flex-center {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
    }
    .loading-spinner {
      border: 4px solid #3b82f6;
      border-top: 4px solid transparent;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      animation: spin 1s linear infinite;
      margin-left: 0.5rem;
    }
    @keyframes spin {
      to { transform: rotate(360deg);}
    }
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem 1rem;
      margin: 0.5rem 0;
      user-select: none;
    }
    .checkbox-group label {
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #374151;
    }
    body.dark .checkbox-group label {
      color: #9ca3af;
    }
    /* Responsive */
    @media (max-width: 600px) {
      #map {
        height: 220px;
      }
      #app {
        margin: 1rem;
        padding: 1rem;
      }
    }
  </style>
</head>
<body>

<div id="app" role="main" aria-label="Panel pemesanan ojek dengan login dan peta Google Maps">

  <!-- Login Panel -->
  <section id="login-panel" aria-label="Form login pengguna">
    <h1>Login Untuk Memesan</h1>
    <form id="login-form" novalidate>
      <div>
        <label for="username">Nama Pengguna</label>
        <input type="text" id="username" name="username" autocomplete="username" required placeholder="Masukkan nama pengguna"/>
        <p id="username-error" class="error-msg" aria-live="polite"></p>
      </div>
      <div>
        <label for="password">Kata Sandi</label>
        <input type="password" id="password" name="password" autocomplete="current-password" required placeholder="Masukkan kata sandi"/>
        <p id="password-error" class="error-msg" aria-live="polite"></p>
      </div>
      <button type="submit" id="login-button">Masuk</button>
    </form>
  </section>

  <!-- Order Panel -->
  <section id="order-panel" aria-label="Form pemesanan ojek" hidden>
    <h1>Pesan Jasa Ojek</h1>

    <p class="permission-request" id="permission-instruction">
      Untuk pengalaman terbaik, izinkan akses lokasi perangkat anda ketika diminta.
    </p>

    <form id="order-form" novalidate>
      <div>
        <label for="pickup">Alamat Penjemputan</label>
        <input type="text" id="pickup" name="pickup" placeholder="Ketik alamat penjemputan atau pilih di peta" autocomplete="off" required aria-describedby="pickup-error" />
        <p id="pickup-error" class="error-msg" aria-live="polite"></p>
      </div>

      <div>
        <label for="destination">Alamat Tujuan</label>
        <input type="text" id="destination" name="destination" placeholder="Ketik alamat tujuan atau pilih di peta" autocomplete="off" required aria-describedby="destination-error" />
        <p id="destination-error" class="error-msg" aria-live="polite"></p>
      </div>

      <div id="map" role="region" aria-label="Peta Google Maps untuk memilih lokasi"></div>

      <div class="checkbox-group" role="group" aria-label="Perizinan aplikasi">
        <label><input type="checkbox" id="gps-permission" disabled checked /> GPS (lokasi)</label>
        <label><input type="checkbox" id="phone-permission" disabled/> Telepon</label>
        <label><input type="checkbox" id="storage-permission" disabled/> Penyimpanan</label>
        <label><input type="checkbox" id="mic-permission" disabled/> Mikrofon</label>
      </div>

      <button type="submit" id="order-submit" disabled aria-disabled="true">
        Pesan Sekarang
        <span class="material-icons">motorcycle</span>
      </button>
    </form>

    <div id="status-message" aria-live="polite" role="alert" style="min-height:1.25rem;margin-top:0.75rem;"></div>
  </section>
</div>

<script>
  // Elements & state
  const loginPanel = document.getElementById('login-panel');
  const orderPanel = document.getElementById('order-panel');
  const loginForm = document.getElementById('login-form');
  const usernameField = document.getElementById('username');
  const passwordField = document.getElementById('password');
  const usernameError = document.getElementById('username-error');
  const passwordError = document.getElementById('password-error');
  const pickupInput = document.getElementById('pickup');
  const destinationInput = document.getElementById('destination');
  const pickupError = document.getElementById('pickup-error');
  const destinationError = document.getElementById('destination-error');
  const orderSubmit = document.getElementById('order-submit');
  const statusMessage = document.getElementById('status-message');
  const gpsCheckbox = document.getElementById('gps-permission');
  const phoneCheckbox = document.getElementById('phone-permission');
  const storageCheckbox = document.getElementById('storage-permission');
  const micCheckbox = document.getElementById('mic-permission');
  const permissionInstruction = document.getElementById('permission-instruction');

  let map;
  let pickupMarker;
  let destinationMarker;
  let autocompletePickup;
  let autocompleteDestination;
  let currentPickupLocation = null;
  let currentDestinationLocation = null;
  let userPosition = null;

  // Fake login validation
  loginForm.addEventListener('submit', (e) => {
    e.preventDefault();
    usernameError.textContent = '';
    passwordError.textContent = '';
    let valid = true;
    if (!usernameField.value.trim()) {
      usernameError.textContent = 'Nama pengguna wajib diisi.';
      valid = false;
    }
    if (!passwordField.value) {
      passwordError.textContent = 'Kata sandi wajib diisi.';
      valid = false;
    }
    if (!valid) return;

    // For demo, accept any login
    loginPanel.hidden = true;
    orderPanel.hidden = false;
    permissionInstruction.textContent = 'Tolong izinkan akses lokasi untuk melanjutkan pemesanan.';
    initPermissionsAndMap();
  });

  // Initialize permissions and map after login
  function initPermissionsAndMap() {
    // Request location permission
    if (navigator.permissions) {
      navigator.permissions.query({ name: 'geolocation' }).then((result) => {
        if (result.state === 'granted') {
          gpsCheckbox.checked = true;
          getUserLocation();
        } else if (result.state === 'prompt') {
          permissionInstruction.textContent = 'Izinkan akses lokasi saat diminta untuk menggunakan fitur peta.';
          gpsCheckbox.checked = false;
        } else {
          permissionInstruction.textContent = 'Anda menolak akses lokasi, fitur peta dan pelacakan mungkin terbatas.';
          gpsCheckbox.checked = false;
        }
        result.onchange = function () {
          gpsCheckbox.checked = this.state === 'granted';
          if (this.state === 'granted') getUserLocation();
        };
      });
    } else {
      // fallback if no permission API
      permissionInstruction.textContent = 'Browser tidak mendukung API izin lokasi, izinkan akses lokasi secara manual.';
      gpsCheckbox.checked = false;
    }

    // For phone, storage, mic permissions we simulate / placeholder (cannot request from web easily)
    phoneCheckbox.checked = false;
    storageCheckbox.checked = false;
    micCheckbox.checked = false;

    // After permissions check load map
    loadGoogleMapsAPI(initMap);
  }

  // Load Google Maps script dynamically
  function loadGoogleMapsAPI(callback) {
    if (window.google && window.google.maps) {
      callback();
      return;
    }
    const script = document.createElement('script');
    script.src =
      'https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places&language=id&region=ID&callback=initMap';
    script.async = true;
    script.defer = true;
    window.initMap = callback;
    script.onerror = () => {
      statusMessage.textContent = 'Gagal memuat Google Maps. Periksa koneksi internet Anda.';
    };
    document.head.appendChild(script);
  }

  // Initialize Map and Autocomplete
  function initMap() {
    const defaultCenter = { lat: -8.168, lng: 113.703 };

    map = new google.maps.Map(document.getElementById('map'), {
      center: defaultCenter,
      zoom: 13,
      streetViewControl: false,
      fullscreenControl: false,
      mapTypeControl: false,
      zoomControl: true,
      styles: window.matchMedia('(prefers-color-scheme: dark)').matches ? darkMapStyle : [],
    });

    pickupMarker = new google.maps.Marker({
      map,
      draggable: true,
      icon: "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
      title: "Lokasi Penjemputan",
    });
    destinationMarker = new google.maps.Marker({
      map,
      draggable: true,
      icon: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
      title: "Lokasi Tujuan",
    });

    // Update input and estimate on marker drag end
    pickupMarker.addListener('dragend', () => {
      geocodePosition(pickupMarker.getPosition()).then(setPickupAddressFromGeocode);
    });
    destinationMarker.addListener('dragend', () => {
      geocodePosition(destinationMarker.getPosition()).then(setDestinationAddressFromGeocode);
    });

    autocompletePickup = new google.maps.places.Autocomplete(pickupInput, {
      fields: ['geometry', 'formatted_address'],
      types: ['address'],
      componentRestrictions: { country: 'id' },
    });
    autocompletePickup.addListener('place_changed', () => {
      const place = autocompletePickup.getPlace();
      if (!place.geometry) return;
      setPickupLocation(place.geometry.location);
    });

    autocompleteDestination = new google.maps.places.Autocomplete(destinationInput, {
      fields: ['geometry', 'formatted_address'],
      types: ['address'],
      componentRestrictions: { country: 'id' },
    });
    autocompleteDestination.addListener('place_changed', () => {
      const place = autocompleteDestination.getPlace();
      if (!place.geometry) return;
      setDestinationLocation(place.geometry.location);
    });

    orderFormListeners();
  }

  const darkMapStyle = [
    { elementType: 'geometry', stylers: [{ color: '#1f2937' }] },
    { elementType: 'labels.text.stroke', stylers: [{ color: '#1f2937' }]},
    { elementType: 'labels.text.fill', stylers: [{ color: '#e5e7eb' }]},
    { featureType: 'administrative', elementType: 'geometry', stylers: [{ color: '#374151' }]},
    { featureType: 'poi', elementType: 'labels.text.fill', stylers: [{ color: '#9ca3af' }]},
    { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#374151' }]},
    { featureType: 'road', elementType: 'labels.text.fill', stylers: [{ color: '#6b7280' }]},
    { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#111827' }]},
    { featureType: 'water', elementType: 'labels.text.fill', stylers: [{ color: '#9ca3af' }] }
  ];

  function orderFormListeners() {
    pickupInput.addEventListener('input', onAddressInputChange);
    destinationInput.addEventListener('input', onAddressInputChange);

    document.getElementById('order-form').addEventListener('submit', onSubmit);
  }

  function onAddressInputChange() {
    validateInputsAndUpdateMarkers();
  }

  function validateInputsAndUpdateMarkers() {
    const pickup = pickupInput.value.trim();
    const destination = destinationInput.value.trim();

    if (pickup && destination) {
      orderSubmit.disabled = false;
      orderSubmit.setAttribute('aria-disabled', 'false');
    } else {
      orderSubmit.disabled = true;
      orderSubmit.setAttribute('aria-disabled', 'true');
    }
  }

  function setPickupLocation(location) {
    currentPickupLocation = location;
    pickupMarker.setPosition(location);
    map.panTo(location);
    map.setZoom(15);
    pickupInput.value = locationToString(location);
    validateInputsAndUpdateMarkers();
  }

  function setDestinationLocation(location) {
    currentDestinationLocation = location;
    destinationMarker.setPosition(location);
    map.panTo(location);
    map.setZoom(15);
    destinationInput.value = locationToString(location);
    validateInputsAndUpdateMarkers();
  }

  function locationToString(location) {
    return `${location.lat().toFixed(5)}, ${location.lng().toFixed(5)}`;
  }

  function setPickupAddressFromGeocode(address) {
    pickupInput.value = address;
    validateInputsAndUpdateMarkers();
  }
  function setDestinationAddressFromGeocode(address) {
    destinationInput.value = address;
    validateInputsAndUpdateMarkers();
  }

  function geocodePosition(pos) {
    return new Promise((resolve, reject) => {
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ location: pos }, (results, status) => {
        if (status === 'OK' && results[0]) {
          resolve(results[0].formatted_address);
        } else {
          resolve(locationToString(pos));
        }
      });
    });
  }

  function getUserLocation() {
    if (!navigator.geolocation) return promiseRejectWithMsg('Geolocation tidak didukung browser ini.');
    return new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(
        (pos) => resolve(pos.coords),
        (err) => reject(err)
      );
    });
  }

  async function initializeUserLocation() {
    try {
      const coords = await getUserLocation();
      userPosition = { lat: coords.latitude, lng: coords.longitude };
      setPickupLocation(new google.maps.LatLng(userPosition.lat, userPosition.lng));
    } catch {
      // Can't get location; skip default marker placement
    }
  }

  async function onSubmit(e) {
    e.preventDefault();
    orderSubmit.disabled = true;
    orderSubmit.textContent = 'Memproses pesanan...';
    statusMessage.textContent = '';

    // Validate once more
    const pickupVal = pickupInput.value.trim();
    const destVal = destinationInput.value.trim();

    if (!pickupVal || !destVal) {
      statusMessage.textContent = 'Mohon isi alamat penjemputan dan tujuan.';
      orderSubmit.disabled = false;
      orderSubmit.textContent = 'Pesan Sekarang';
      return;
    }

    // Simulate sending order, replace with real API calls
    setTimeout(() => {
      statusMessage.textContent = 'Pesanan Anda berhasil dibuat! Driver akan segera menghubungi Anda.';
      orderSubmit.textContent = 'Pesan Sekarang';
      orderSubmit.disabled = false;
      // Optionally: reset form or redirect
    }, 2500);
  }

  // Detect dark mode
  function setupDarkModeToggle() {
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    // For demo always start light
    document.body.classList.remove('dark');
  }

  // Initialization
  window.onload = () => {
    // Only enable map after user logs in and grants location permission — here simulated by showing order panel directly
    setupDarkModeToggle();

    // TODO: You may add login logic here or redirect

    // Load map and autocomplete:
    loadGoogleMaps(() => {
      initMapAndAutocomplete();
      initializeUserLocation();
    });
  };

  function loadGoogleMaps(callback) {
    if (window.google && window.google.maps) {
      callback();
      return;
    }
    const script = document.createElement('script');
    // **GANTI YOUR_GOOGLE_MAPS_API_KEY dengan API key yang valid**
    script.src =
      'https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places&language=id&region=ID&callback=initMapAndAutocomplete';
    script.async = true;
    script.defer = true;
    window.initMapAndAutocomplete = callback;
    document.head.appendChild(script);
  }

  let map, pickupMarker, destinationMarker, autocompletePickup, autocompleteDest;
  let userPosition = null;

  function initMapAndAutocomplete() {
    const center = { lat: -8.168, lng: 113.703 };
    map = new google.maps.Map(document.getElementById('map'), {
      center: center,
      zoom: 13,
      streetViewControl: false,
      fullscreenControl: false,
    });

    pickupMarker = new google.maps.Marker({
      map,
      draggable: true,
      icon: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
      title: 'Lokasi Penjemputan',
    });
    destinationMarker = new google.maps.Marker({
      map,
      draggable: true,
      icon: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
      title: 'Lokasi Tujuan',
    });

    pickupMarker.addListener('dragend', () => {
      geocodePosition(pickupMarker.getPosition()).then(setPickupAddressFromGeocode);
    });
    destinationMarker.addListener('dragend', () => {
      geocodePosition(destinationMarker.getPosition()).then(setDestinationAddressFromGeocode);
    });

    autocompletePickup = new google.maps.places.Autocomplete(pickupInput, {
      fields: ['geometry', 'formatted_address'],
      types: ['address'],
      componentRestrictions: { country: 'id' },
    });
    autocompletePickup.addListener('place_changed', () => {
      const place = autocompletePickup.getPlace();
      if (place.geometry) {
        setPickupLocation(place.geometry.location);
      }
    });

    autocompleteDest = new google.maps.places.Autocomplete(destinationInput, {
      fields: ['geometry', 'formatted_address'],
      types: ['address'],
      componentRestrictions: { country: 'id' },
    });
    autocompleteDest.addListener('place_changed', () => {
      const place = autocompleteDest.getPlace();
      if (place.geometry) {
        setDestinationLocation(place.geometry.location);
      }
    });

    pickupInput.addEventListener('input', validateFormInputs);
    destinationInput.addEventListener('input', validateFormInputs);

    validateFormInputs();
  }

  function validateFormInputs() {
    const pickupVal = pickupInput.value.trim();
    const destVal = destinationInput.value.trim();

    if (pickupVal && destVal) {
      orderSubmit.disabled = false;
      orderSubmit.setAttribute('aria-disabled', 'false');
    } else {
      orderSubmit.disabled = true;
      orderSubmit.setAttribute('aria-disabled', 'true');
    }
  }

  function setPickupLocation(latlng) {
    currentPickupLocation = latlng;
    pickupMarker.setPosition(latlng);
    pickupInput.value = '';
    geocodePosition(latlng).then(address => {
      pickupInput.value = address;
    });
    map.panTo(latlng);
    map.setZoom(15);
    validateFormInputs();
  }

  function setDestinationLocation(latlng) {
    currentDestinationLocation = latlng;
    destinationMarker.setPosition(latlng);
    destinationInput.value = '';
    geocodePosition(latlng).then(address => {
      destinationInput.value = address;
    });
    map.panTo(latlng);
    map.setZoom(15);
    validateFormInputs();
  }

  function setPickupAddressFromGeocode(address) {
    pickupInput.value = address;
    validateFormInputs();
  }
  function setDestinationAddressFromGeocode(address) {
    destinationInput.value = address;
    validateFormInputs();
  }

  function geocodePosition(position) {
    return new Promise((resolve) => {
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ location: position }, (results, status) => {
        if (status === 'OK' && results[0]) {
          resolve(results[0].formatted_address);
        } else {
          resolve(position.toString());
        }
      });
    });
  }

  function getUserGeolocation() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject('Geolocation tidak didukung browser');
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
        (err) => reject(err.message)
      );
    });
  }

  // Request geolocation and center map + set default pickup
  getUserGeolocation()
    .then((pos) => {
      userPosition = pos;
      setPickupLocation(new google.maps.LatLng(pos.lat, pos.lng));
    })
    .catch(() => {
      // fallback center
      map && map.setCenter({ lat: -8.168, lng: 113.703 });
    });
</script>
</body>
</html>
