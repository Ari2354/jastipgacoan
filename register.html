<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Daftar Akun Baru</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: 'Poppins', Arial, sans-serif;
            background-color: #f8f9fa;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .register-container {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            padding: 32px 28px 24px 28px;
            width: 100%;
            max-width: 370px;
        }
        .register-container h2 {
            color: #E53935;
            font-weight: 700;
            text-align: center;
            margin-bottom: 28px;
        }
        .form-label {
            font-weight: 500;
            color: #E53935;
        }
        .form-control:focus {
            border-color: #E53935;
            box-shadow: 0 0 0 0.2rem rgba(229,57,53,.15);
        }
        .btn-primary {
            background-color: #E53935;
            border-color: #E53935;
            font-weight: 600;
        }
        .btn-primary:hover {
            background-color: #b71c1c;
            border-color: #b71c1c;
        }
        .btn-google {
            background: #fff;
            color: #444;
            border: 1px solid #ddd;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
            transition: background 0.2s;
        }
        .btn-google:hover {
            background: #f1f1f1;
        }
        .btn-google img {
            width: 22px;
            height: 22px;
        }
        .error-message {
            color: #d32f2f;
            font-size: 13px;
            margin-top: 6px;
            display: none;
        }
        .success-message {
            color: #388e3c;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
            display: none;
        }
        .text-center {
            text-align: center;
        }
        .mt-3 {
            margin-top: 1rem !important;
        }
    </style>
</head>
<body>
    <div class="register-container">
        <h2>Daftar Akun</h2>
        <form id="registerForm" novalidate>
            <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" id="email" name="email" class="form-control" required placeholder="Masukkan email Anda" />
                <div class="error-message" id="emailError">Masukkan email yang valid.</div>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Kata Sandi</label>
                <input type="password" id="password" name="password" class="form-control" required minlength="6" placeholder="Minimal 6 karakter" />
                <div class="error-message" id="passwordError">Kata sandi minimal 6 karakter.</div>
            </div>
            <div class="mb-3">
                <label for="confirmPassword" class="form-label">Konfirmasi Kata Sandi</label>
                <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" required placeholder="Ulangi kata sandi" />
                <div class="error-message" id="confirmPasswordError">Konfirmasi kata sandi tidak cocok.</div>
            </div>
            <button type="submit" class="btn btn-primary w-100 mt-2">Daftar</button>
            <div class="success-message" id="successMessage">Registrasi berhasil! Mengalihkan...</div>
            <div class="error-message" id="firebaseError"></div>
        </form>
        <button type="button" id="googleSignUp" class="btn btn-google w-100">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google Logo">
            Daftar dengan Google
        </button>
        <div class="text-center mt-3">
            <span>Sudah punya akun? <a href="login.html">Login di sini</a></span>
        </div>
    </div>
    <script type="module">
import { auth, provider, db } from './firebase/firebase-js-app/src/firebase.js';
import { createUserWithEmailAndPassword, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
import { setDoc, doc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

const form = document.getElementById('registerForm');
const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');
const confirmPasswordInput = document.getElementById('confirmPassword');

const emailError = document.getElementById('emailError');
const passwordError = document.getElementById('passwordError');
const confirmPasswordError = document.getElementById('confirmPasswordError');
const successMessage = document.getElementById('successMessage');
const firebaseError = document.getElementById('firebaseError');
const googleButton = document.getElementById('googleSignUp');

function validateEmail(email) {
    const re = /^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/;
    return re.test(email);
}

form.addEventListener('submit', async function (e) {
    e.preventDefault();

    let valid = true;

    // Reset error messages
    emailError.style.display = 'none';
    passwordError.style.display = 'none';
    confirmPasswordError.style.display = 'none';
    successMessage.style.display = 'none';
    firebaseError.style.display = 'none';

    // Validate email
    if (!emailInput.value || !validateEmail(emailInput.value)) {
        emailError.style.display = 'block';
        valid = false;
    }

    // Validate password length
    if (!passwordInput.value || passwordInput.value.length < 6) {
        passwordError.style.display = 'block';
        valid = false;
    }

    // Validate confirm password matches password
    if (confirmPasswordInput.value !== passwordInput.value) {
        confirmPasswordError.style.display = 'block';
        valid = false;
    }

    if (valid) {
        try {
            const userCredential = await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
            // Tambahkan data user ke Firestore dengan role "user"
            await setDoc(doc(db, "users", userCredential.user.uid), {
                email: emailInput.value,
                role: "user",
                createdAt: new Date()
            });
            successMessage.textContent = "Registrasi berhasil! Silakan login.";
            successMessage.style.display = 'block';
            firebaseError.style.display = 'none';
            setTimeout(() => {
                window.location.href = "login.html";
            }, 1800);
        } catch (error) {
            firebaseError.textContent = "Registrasi gagal: " + error.message;
            firebaseError.style.display = 'block';
            successMessage.style.display = 'none';
        }
    }
});

// Google Sign Up
googleButton.addEventListener('click', async () => {
    try {
        const result = await signInWithPopup(auth, provider);
        // Tambahkan data user ke Firestore dengan role "user"
        await setDoc(doc(db, "users", result.user.uid), {
            email: result.user.email,
            role: "user",
            createdAt: new Date()
        });
        successMessage.textContent = "Registrasi dengan Google berhasil! Silakan login.";
        successMessage.style.display = 'block';
        firebaseError.style.display = 'none';
        setTimeout(() => {
            window.location.href = "login.html";
        }, 1800);
    } catch (error) {
        firebaseError.textContent = "Registrasi gagal: " + error.message;
        firebaseError.style.display = 'block';
        successMessage.style.display = 'none';
    }
});
</script>
</body>
</html>